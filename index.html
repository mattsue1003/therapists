<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- é—œéµï¼šç¹éåœ–ç‰‡é˜²ç›œé€£æ©Ÿåˆ¶ï¼Œè®“ç…§ç‰‡èƒ½é¡¯ç¤º -->
    <meta name="referrer" content="no-referrer">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ„›è¿ªæ¨‚æ²»ç™‚å¸«å€‹äººæ¯æœˆKPIè‡ªè©•è¡¨</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React æ ¸å¿ƒ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Recharts ä¾è³´ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.7/Recharts.min.js"></script>
    
    <!-- 4. Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- 5. html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-font-smoothing: antialiased; }
        /* é¿å… iOS è¼¸å…¥æ¡†ç¸®æ”¾ */
        input, select, textarea { font-size: 16px !important; } 
        
        /* æ‰‹æ©Ÿç‰ˆæ¨™é¡Œè‡ªå‹•ç¸®æ”¾æŠ€å·§ï¼šä½¿ç”¨ container queries æ¦‚å¿µçš„æ›¿ä»£æ–¹æ¡ˆ */
        .responsive-title {
            font-size: clamp(1rem, 4vw, 1.25rem); /* æœ€å° 16px, æœ€å¤§ 20px, ä¸­é–“éš¨å¯¬åº¦è®ŠåŒ– */
            white-space: nowrap;
            overflow: visible;
        }
        .responsive-status {
            font-size: clamp(0.75rem, 3vw, 0.875rem);
            white-space: nowrap;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- å…§å»ºåœ–ç¤ºå…ƒä»¶ (å·²ä¿®å¾© JSX å¤šè·¯å¾‘åŒ…è¦†å•é¡Œ) ---
        const Icon = ({ name, className }) => {
            const icons = {
                plus: <path d="M5 12h14M12 5v14" />,
                trash: <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6" />,
                save: <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2zM17 21v-8H7v8M7 3v5h8" />,
                download: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" />,
                check: <path d="M20 6 9 17l-5-5" />,
                // ä¿®æ­£ï¼šå¤šè·¯å¾‘åœ–ç¤ºå¿…é ˆåŒ…åœ¨ <React.Fragment> æˆ– <> ä¸­
                copy: <><rect width="13" height="13" x="9" y="9" rx="2" ry="2" /><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" /></>,
                user: <><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></>,
                clock: <><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></>,
                calendar: <><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" x2="16" y1="2" y2="6" /><line x1="8" x2="8" y1="2" y2="6" /><line x1="3" x2="21" y1="10" y2="10" /></>,
                chevronDown: <path d="m6 9 6 6 6-6" />,
                clipboard: <><rect width="8" height="4" x="8" y="2" rx="1" ry="1" /><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" /></>,
                trending: <><polyline points="23 6 13.5 15.5 8.5 10.5 1 18" /><polyline points="17 6 23 6 23 12" /></>,
                loader: <path d="M21 12a9 9 0 1 1-6.219-8.56" />
            };
            return (
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    width="24" height="24" 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    stroke="currentColor" 
                    strokeWidth="2" 
                    strokeLinecap="round" 
                    strokeLinejoin="round" 
                    className={className}
                >
                    {icons[name]}
                </svg>
            );
        };

        // --- Constants ---
        const BRANCHES = ["æ¾æ±Ÿæ‰€", "ä¸­å±±æ‰€"];
        const MONTHS = Array.from({ length: 12 }, (_, i) => `${i + 1} æœˆ`);
        const THERAPISTS = [
            { name: 'é¾å­Ÿä¿®', title: 'è·èƒ½æ²»ç™‚å¸«', type: 'OT', avatar: 'https://adlers.tw/wp-content/uploads/2021/03/08161275%E6%8B%B7%E8%B2%9D.jpg' },
            { name: 'é„­å‡±æ–‡', title: 'è·èƒ½æ²»ç™‚å¸«', type: 'OT', avatar: 'https://adlers.tw/wp-content/uploads/2021/05/08162446%E6%8B%B7%E8%B2%9D.jpg' },
            { name: 'é™³èƒ¤ç”«', title: 'ç‰©ç†æ²»ç™‚å¸«', type: 'PT', avatar: 'https://adlers.tw/wp-content/uploads/2021/05/08162364%E6%8B%B7%E8%B2%9D.jpg' },
            { name: 'è¬è¿ªäº', title: 'ç‰©ç†æ²»ç™‚å¸«', type: 'PT', avatar: 'https://adlers.tw/wp-content/uploads/2021/05/08163287%E6%8B%B7%E8%B2%9D.jpg' },
            { name: 'å·«ä½³å€«', title: 'ç‰©ç†æ²»ç™‚å¸«', type: 'PT', avatar: 'https://adlers.tw/wp-content/uploads/2021/03/08162832%E6%8B%B7%E8%B2%9D.jpg' },
            { name: 'è¨±æ™ƒå˜‰', title: 'ç‰©ç†æ²»ç™‚å¸«', type: 'PT', avatar: 'https://adlers.tw/wp-content/uploads/2023/03/%E8%A8%B1%E6%99%83%E5%98%89-%E7%89%A9%E7%90%86%E6%B2%BB%E7%99%82%E5%B8%AB.jpg' },
            { name: 'é„­ä¹‹å§¸', title: 'ç‰©ç†æ²»ç™‚å¸«', type: 'PT', avatar: 'https://adlers.tw/wp-content/uploads/2025/07/%E9%84%AD%E4%B9%8B%E5%A7%B8%E5%BD%A2%E8%B1%A1%E7%85%A72.jpg' },
            { name: 'è‘‰ç¾½åº­', title: 'ç‰©ç†æ²»ç™‚å¸«', type: 'PT', avatar: 'https://adlers.tw/wp-content/uploads/2024/04/%E8%91%89%E7%BE%BD%E5%BA%AD.jpg' },
            { name: 'é™³ç««æ²‚', title: 'ç‰©ç†æ²»ç™‚å¸«', type: 'PT', avatar: 'https://adlers.tw/wp-content/uploads/2024/08/%E9%99%B3%E7%AB%AB%E6%B2%82%E7%89%A9%E7%90%86%E6%B2%BB%E7%99%82%E5%B8%AB3.jpg.png' },
        ];
        const KPI_CONFIG = [
            { id: 'occupancy', label: 'æ»¿ç­ç‡', unit: '%', target: 80, type: 'higher_better', desc: 'ç•¶æœˆå¯¦éš›çœ‹è¨ºæ™‚æ®µ Ã· å¯æ’æ™‚æ®µ', isPercentage: true },
            { id: 'newCases', label: 'æ–°å¢å€‹æ¡ˆæ•¸', unit: 'äºº', target: 15, type: 'higher_better', desc: 'æœ¬æœˆç¬¬ä¸€æ¬¡ä¾†æ‰¾ä½ çš„æ–°å€‹æ¡ˆ' },
            { id: 'regularClients', label: 'å›ºå®šå®¢ç¾¤æ•¸', unit: 'äºº', target: 30, type: 'higher_better', desc: 'æŒçºŒå›ä¾†è¿½è¹¤æˆ–ä¿é¤Šçš„å€‹æ¡ˆ' },
            { id: 'totalHours', label: 'ç¸½æ²»ç™‚æ™‚æ•¸', unit: 'hr', target: 120, type: 'higher_better', desc: 'æœ¬æœˆå¯¦éš›æ²»ç™‚ç¸½æ™‚æ•¸' },
            { id: 'conversionRate', label: 'å•è¨ºè½‰æ›ç‡', unit: '%', target: 60, type: 'higher_better', desc: 'å¾è«®è©¢/è©¢å•åˆ°å¯¦éš›é–‹å§‹ç™‚ç¨‹çš„æ¯”ä¾‹', isPercentage: true },
            { id: 'returnRate', label: 'å›è¨ºç‡', unit: '%', target: 70, type: 'higher_better', desc: 'æœ‰æ²’æœ‰é¡˜æ„å†å›ä¾†ç¹¼çºŒç™‚ç¨‹', isPercentage: true },
            { id: 'satisfaction', label: 'å¹³å‡æ»¿æ„åº¦', unit: 'åˆ†', target: 4.6, max: 5, type: 'higher_better', desc: 'å€‹æ¡ˆåœ¨å•å·æˆ–å›é¥‹ä¸­å°ä½ çš„æ•´é«”æ»¿æ„ç¨‹åº¦', isScore: true },
            { id: 'complaints', label: 'å®¢è¨´ä»¶æ•¸', unit: 'ä»¶', target: 0, warning: 1, type: 'lower_better', desc: 'èˆ‡ä½ ç›¸é—œã€éœ€è¦ä¸»ç®¡ä»‹å…¥è™•ç†çš„æ­£å¼å®¢è¨´ä»¶æ•¸' },
        ];
        const INITIAL_DATA = { therapistName: '', branch: '', month: '', occupancy: '', newCases: '', regularClients: '', totalHours: '', conversionRate: '', returnRate: '', satisfaction: '', complaints: '', growthFocus: '', teamContribution: '' };

        // --- Helper Functions ---
        const getStatusLevel = (value, config) => {
            if (value === '' || value === undefined) return 'empty';
            const val = parseFloat(value) || 0;
            if (config.type === 'lower_better') {
                if (val <= config.target) return 'success';
                if (val <= config.warning) return 'warning';
                return 'error';
            }
            if (val >= config.target) return 'success';
            if (val >= config.target * 0.8) return 'warning';
            return 'error';
        };
        const getStatus = (value, config) => {
            const level = getStatusLevel(value, config);
            if (level === 'empty') return { label: 'æœªå¡«', color: 'bg-slate-100 text-slate-400 border-slate-200' };
            if (level === 'success') return { label: 'é”æ¨™', color: 'bg-emerald-50 text-emerald-700 border-emerald-200' };
            if (level === 'warning') return { label: 'æ³¨æ„', color: 'bg-amber-50 text-amber-700 border-amber-200' };
            return { label: 'éœ€æ”¹å–„', color: 'bg-rose-50 text-rose-700 border-rose-200' };
        };
        const getInputBorderClass = (value, config) => {
            const level = getStatusLevel(value, config);
            if (level === 'error') return 'border-rose-400 ring-1 ring-rose-400 bg-rose-50 text-rose-700';
            if (level === 'empty') return 'border-slate-200 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 bg-slate-50 text-slate-700';
            return 'border-emerald-200 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 bg-slate-50 text-slate-700';
        };
        const normalizeForChart = (value, config) => {
            const val = parseFloat(value) || 0;
            if (config.id === 'satisfaction') return Math.min((val / 5) * 100, 100);
            if (config.id === 'complaints') return val === 0 ? 100 : Math.max(0, 100 - (val * 50));
            let percentage = (val / config.target) * 100;
            return Math.min(percentage, 100);
        };
        const getTherapistInfo = (name) => THERAPISTS.find(t => t.name === name) || { name: name, title: 'æ²»ç™‚å¸«', type: 'OT/PT', avatar: '' };

        // --- Sub Components ---
        const StatusBadge = ({ status }) => <span className={`px-2.5 py-0.5 rounded-full text-xs font-semibold border ${status.color} transition-colors min-w-[60px] text-center`}>{status.label}</span>;

        const ImageWithSkeleton = ({ src, alt, className }) => {
            const [loaded, setLoaded] = useState(false);
            const [error, setError] = useState(false);
            useEffect(() => { setLoaded(false); setError(false); }, [src]);
            return (
                <div className={`relative overflow-hidden ${className}`}>
                    {!loaded && !error && <div className="absolute inset-0 bg-slate-200 animate-pulse flex items-center justify-center"><Icon name="loader" className="animate-spin text-slate-400 w-6 h-6" /></div>}
                    {!error && src && <img src={src} alt={alt} className={`w-full h-full object-cover transition-opacity duration-500 ${loaded ? 'opacity-100' : 'opacity-0'}`} onLoad={() => setLoaded(true)} onError={() => setError(true)} />}
                    {(error || !src) && <div className="absolute inset-0 bg-slate-100 flex items-center justify-center text-slate-300 flex-col gap-1"><Icon name="user" className="w-8 h-8" /><span className="text-[10px]">ç„¡ç…§ç‰‡</span></div>}
                </div>
            );
        };

        const DeleteConfirmModal = ({ isOpen, onClose, onConfirm, item }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[100] flex items-center justify-center p-4 animate-in fade-in duration-200">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 border border-slate-100">
                        <div className="w-12 h-12 rounded-full bg-rose-100 flex items-center justify-center mb-4 text-rose-600"><Icon name="trash" className="w-6 h-6" /></div>
                        <h3 className="text-lg font-bold text-slate-900 mb-2">ç¢ºèªåˆªé™¤ç´€éŒ„ï¼Ÿ</h3>
                        <p className="text-slate-500 text-sm mb-6">æ‚¨å³å°‡åˆªé™¤ <span className="font-semibold text-slate-700">{item?.month} {item?.branch}</span> çš„è©•ä¼°è³‡æ–™ï¼Œæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚</p>
                        <div className="flex gap-3 justify-end">
                            <button onClick={onClose} className="px-4 py-2 rounded-lg text-slate-600 font-medium hover:bg-slate-50">å–æ¶ˆ</button>
                            <button onClick={onConfirm} className="px-4 py-2 rounded-lg bg-rose-600 text-white font-medium hover:bg-rose-700 shadow-md">ç¢ºèªåˆªé™¤</button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [formData, setFormData] = useState(INITIAL_DATA);
            const [history, setHistory] = useState([]);
            const [view, setView] = useState('form');
            const [loading, setLoading] = useState(true);
            const [saveStatus, setSaveStatus] = useState('idle');
            const [copyStatus, setCopyStatus] = useState('idle');
            const [downloading, setDownloading] = useState(false);
            const [deleteModalOpen, setDeleteModalOpen] = useState(false);
            const [itemToDelete, setItemToDelete] = useState(null);
            
            const reportRef = useRef(null);
            const currentTherapist = useMemo(() => getTherapistInfo(formData.therapistName), [formData.therapistName]);
            
            const RechartsComponents = useMemo(() => {
                return window.Recharts || { ResponsiveContainer: 'div', RadarChart: 'div', Radar: 'div', PolarGrid: 'div', PolarAngleAxis: 'div', PolarRadiusAxis: 'div', Tooltip: 'div' };
            }, []);
            const { ResponsiveContainer, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar, Tooltip } = RechartsComponents;
            const radarData = useMemo(() => KPI_CONFIG.map(c => ({ subject: c.label, A: normalizeForChart(formData[c.id], c), fullMark: 100 })), [formData]);

            useEffect(() => {
                const savedDraft = localStorage.getItem('kpi_form_draft');
                if (savedDraft) try { setFormData(prev => ({ ...prev, ...JSON.parse(savedDraft) })); } catch (e) { }
                const savedHistory = localStorage.getItem('kpi_history');
                if (savedHistory) try { setHistory(JSON.parse(savedHistory)); } catch (e) { }
                setLoading(false);
            }, []);

            useEffect(() => {
                const timeoutId = setTimeout(() => localStorage.setItem('kpi_form_draft', JSON.stringify(formData)), 500);
                return () => clearTimeout(timeoutId);
            }, [formData]);

            const handleInputChange = (field, value) => {
                const config = KPI_CONFIG.find(c => c.id === field);
                let newValue = value;
                if (config && value !== '') {
                    let numVal = parseFloat(value);
                    if (config.isPercentage) { if (numVal < 0) numVal = 0; if (numVal > 100) numVal = 100; newValue = numVal; }
                    if (config.isScore) { if (numVal < 0) numVal = 0; if (numVal > 5) numVal = 5; newValue = numVal; }
                }
                setFormData(prev => ({ ...prev, [field]: newValue }));
            };

            const handleSave = () => {
                setSaveStatus('saving');
                const newRecord = { ...formData, id: Date.now(), createdAt: new Date().toISOString() };
                const newHistory = [newRecord, ...history];
                setHistory(newHistory);
                localStorage.setItem('kpi_history', JSON.stringify(newHistory));
                setTimeout(() => { setSaveStatus('success'); setTimeout(() => setSaveStatus('idle'), 2000); }, 500);
            };

            const confirmDelete = () => {
                const newHistory = history.filter(item => item.id !== itemToDelete.id);
                setHistory(newHistory);
                localStorage.setItem('kpi_history', JSON.stringify(newHistory));
                setDeleteModalOpen(false);
                setItemToDelete(null);
            };

            const resetForm = () => {
                if(confirm("ç¢ºå®šè¦é‡ç½®è¡¨å–®å—ï¼Ÿ")) {
                    setFormData(INITIAL_DATA);
                    localStorage.removeItem('kpi_form_draft');
                }
            };

            const copySummary = () => {
                const text = `${formData.month || 'æœªå¡«'}ï½œ${formData.branch || 'æœªå¡«'}ï½œ${formData.therapistName || 'æœªå¡«'} ${currentTherapist.title} KPIè‡ªè©•\n\n` +
                    KPI_CONFIG.map(c => `- ${c.label}ï¼š${formData[c.id] || 'æœªå¡«'} ${c.unit}`).join('\n') +
                    `\n\nğŸ§  æŠ€è¡“æˆé•·ï¼š\n${formData.growthFocus || 'ç„¡'}\n\nğŸ¤ åœ˜éšŠè²¢ç»ï¼š\n${formData.teamContribution || 'ç„¡'}`;
                const ta = document.createElement("textarea");
                ta.value = text;
                ta.style.position = "fixed"; ta.style.left = "-9999px";
                document.body.appendChild(ta); ta.focus(); ta.select();
                try { document.execCommand('copy'); setCopyStatus('copied'); setTimeout(() => setCopyStatus('idle'), 2000); } catch (e) { alert('è¤‡è£½å¤±æ•—'); }
                document.body.removeChild(ta);
            };

            const downloadImage = async () => {
                if (!reportRef.current) return;
                setDownloading(true);
                try {
                    const canvas = await html2canvas(reportRef.current, {
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#f8fafc',
                        windowWidth: 1280, // å¼·åˆ¶æ¨¡æ“¬é›»è…¦å¯¬åº¦ï¼Œç¢ºä¿é›™æ¬„
                        onclone: (clonedDoc) => {
                            const mainElement = clonedDoc.getElementById('report-main');
                            if (mainElement) {
                                // å¼·åˆ¶è¨­å®šå¯¬åº¦ç‚º 1024pxï¼Œè§¸ç™¼å¤§è¢å¹•æ’ç‰ˆ
                                mainElement.style.width = '1024px';
                                mainElement.style.margin = '0 auto';
                                mainElement.style.padding = '40px';
                                
                                // ä¿®æ­£ä¸‹è¼‰æŒ‰éˆ•çš„éš±è—æ–¹å¼
                                const actionButtons = clonedDoc.getElementById('action-buttons-container');
                                if (actionButtons) actionButtons.style.display = 'none';
                            }
                        }
                    });
                    const link = document.createElement("a");
                    link.href = canvas.toDataURL("image/png");
                    link.download = `${formData.month || 'KPI'}_${formData.therapistName || 'è‡ªè©•è¡¨'}.png`;
                    link.click();
                } catch (e) { console.error(e); alert("ä¸‹è¼‰å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦"); } finally { setDownloading(false); }
            };

            if (loading) return <div className="flex h-screen items-center justify-center text-slate-400">è¼‰å…¥ä¸­...</div>;

            return (
                <div className="min-h-screen bg-slate-50/50 pb-20 selection:bg-indigo-100 selection:text-indigo-700">
                    <DeleteConfirmModal isOpen={deleteModalOpen} onClose={() => setDeleteModalOpen(false)} onConfirm={confirmDelete} item={itemToDelete} />
                    
                    {/* Header: æ‰‹æ©Ÿç‰ˆå‚ç›´å †ç–Šï¼Œç¢ºä¿ä¸æ›è¡Œï¼›é›»è…¦ç‰ˆæ©«å‘ */}
                    <header className="bg-white/80 backdrop-blur-md border-b border-slate-200/60 sticky top-0 z-20">
                        <div className="max-w-6xl mx-auto px-4 py-4 flex flex-col md:flex-row items-center justify-between gap-4">
                            <div className="flex flex-col items-center gap-2 md:flex-row md:gap-4 w-full md:w-auto">
                                {/* è¡Œ1: Logo */}
                                <img src="https://adlers.tw/wp-content/uploads/2021/01/%E6%9C%AA%E5%91%BD%E5%90%8D-3_%E5%B7%A5%E4%BD%9C%E5%8D%80%E5%9F%9F-1-1.png" alt="Logo" className="h-10 md:h-12 w-auto object-contain" />
                                
                                <div className="text-center md:text-left flex flex-col items-center md:items-start gap-1 w-full">
                                    {/* è¡Œ2: æ¨™é¡Œ (responsive-title class æ§åˆ¶å­—é«”å¤§å°ï¼Œç¢ºä¿ä¸€è¡Œ) */}
                                    <h1 className="font-bold text-slate-800 responsive-title">æ„›è¿ªæ¨‚æ²»ç™‚å¸«å€‹äººæ¯æœˆKPIè‡ªè©•è¡¨</h1>
                                    
                                    {/* è¡Œ3: ç‹€æ…‹ (responsive-status class) */}
                                    <div className="font-medium text-slate-500 responsive-status flex items-center justify-center md:justify-start gap-1">
                                        <span>ç³»çµ±è‡ªå‹•ç®—å‡º KPI ç‹€æ…‹ï¼š</span>
                                        <span>ğŸŸ¢é”æ¨™ ğŸŸ¡æ³¨æ„ ğŸ”´éœ€æ”¯æ´</span>
                                    </div>
                                </div>
                            </div>
                            
                            {/* è¡Œ4: æŒ‰éˆ• */}
                            <div className="flex bg-slate-100/80 p-1 rounded-xl shrink-0 w-full md:w-auto justify-center max-w-[300px] md:max-w-none mx-auto md:mx-0">
                                <button onClick={() => setView('form')} className={`flex-1 md:flex-none px-6 md:px-4 py-1.5 rounded-lg text-sm font-semibold transition-all ${view === 'form' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500'}`}>ç·¨è¼¯</button>
                                <button onClick={() => setView('history')} className={`flex-1 md:flex-none px-6 md:px-4 py-1.5 rounded-lg text-sm font-semibold transition-all ${view === 'history' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500'}`}>ç´€éŒ„</button>
                            </div>
                        </div>
                    </header>

                    <main id="report-main" className="max-w-6xl mx-auto px-4 py-8" ref={view === 'form' ? reportRef : null}>
                        {view === 'history' ? (
                            <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                                <div className="flex justify-between items-end mb-8">
                                    <h2 className="text-2xl font-bold text-slate-800">æ­·å²å­˜æª”</h2>
                                    <button onClick={() => { resetForm(); setView('form'); }} className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-xl shadow-lg active:scale-95">
                                        <Icon name="plus" className="w-4 h-4" /> æ–°è©•ä¼°
                                    </button>
                                </div>
                                {history.length === 0 ? (
                                    <div className="flex flex-col items-center justify-center py-24 bg-white rounded-3xl border border-dashed border-slate-200 text-slate-300">
                                        <Icon name="clock" className="w-12 h-12 mb-2" />
                                        <p>å°šç„¡å­˜æª”ç´€éŒ„</p>
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {history.map(record => (
                                            <div key={record.id} className="group flex items-center justify-between p-5 mb-3 rounded-xl border border-slate-100 bg-white shadow-sm hover:border-indigo-200 hover:shadow-md cursor-pointer transition-all" onClick={() => { setFormData(record); setView('form'); }}>
                                                <div className="flex flex-col gap-1">
                                                    <div className="flex items-center gap-2">
                                                        <span className="font-bold text-slate-800 text-lg">{record.month}</span>
                                                        <span className="text-slate-300">|</span>
                                                        <span className="text-slate-600 font-medium">{record.branch}</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 text-xs text-slate-400">
                                                        <Icon name="clock" className="w-3 h-3" />
                                                        <span>{new Date(record.createdAt).toLocaleDateString()}</span>
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-3">
                                                    <span className="text-sm text-slate-600">{record.therapistName}</span>
                                                    <button onClick={(e) => { e.stopPropagation(); setItemToDelete(record); setDeleteModalOpen(true); }} className="p-2 text-slate-300 hover:text-rose-500 rounded-full">
                                                        <Icon name="trash" className="w-4 h-4" />
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 animate-in fade-in duration-500">
                                {/* Left Column: Form */}
                                <div className="lg:col-span-7 space-y-6">
                                    <section className="bg-white p-6 md:p-8 rounded-3xl shadow-sm border border-slate-100 relative overflow-hidden">
                                        <div className="flex flex-col sm:flex-row items-center sm:items-start gap-6">
                                            <div className="flex flex-col items-center gap-3 shrink-0">
                                                <div className="w-32 rounded-2xl bg-slate-100 p-1 border-2 border-slate-200 shadow-sm overflow-hidden group">
                                                    <ImageWithSkeleton src={currentTherapist.avatar} alt={currentTherapist.name} className="w-full h-auto rounded-xl bg-slate-200 aspect-[3/4]" />
                                                </div>
                                                <span className="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full">{currentTherapist.type}</span>
                                            </div>
                                            <div className="flex-1 space-y-5 w-full">
                                                <div className="flex items-center gap-3 mb-2 pb-2 border-b border-slate-50"><h2 className="text-lg font-bold text-slate-800">åŸºæœ¬è³‡æ–™</h2></div>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                                                    <div className="space-y-1.5 md:col-span-2">
                                                        <label className="text-xs font-bold text-slate-400 uppercase ml-1">æ²»ç™‚å¸«å§“å</label>
                                                        <div className="relative">
                                                            <select value={formData.therapistName} onChange={(e) => handleInputChange('therapistName', e.target.value)} className={`w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl font-bold appearance-none ${formData.therapistName ? 'text-slate-700' : 'text-slate-400'}`}>
                                                                <option value="" disabled hidden>è¼¸å…¥å§“å</option>
                                                                <optgroup label="ç‰©ç†æ²»ç™‚å¸« (PT)">{THERAPISTS.filter(t => t.type === 'PT').map(t => <option key={t.name} value={t.name}>{t.name}</option>)}</optgroup>
                                                                <optgroup label="è·èƒ½æ²»ç™‚å¸« (OT)">{THERAPISTS.filter(t => t.type === 'OT').map(t => <option key={t.name} value={t.name}>{t.name}</option>)}</optgroup>
                                                            </select>
                                                            <div className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"><Icon name="chevronDown" className="w-4 h-4" /></div>
                                                        </div>
                                                    </div>
                                                    <div className="space-y-1.5">
                                                        <label className="text-xs font-bold text-slate-400 uppercase ml-1">æ‰€å±¬åˆ†æ‰€</label>
                                                        <div className="relative">
                                                            <select value={formData.branch} onChange={(e) => handleInputChange('branch', e.target.value)} className={`w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl font-medium appearance-none ${formData.branch ? 'text-slate-700' : 'text-slate-400'}`}>
                                                                <option value="" disabled hidden>é»é¸é¸æ“‡</option>
                                                                {BRANCHES.map(b => <option key={b} value={b}>{b}</option>)}
                                                            </select>
                                                            <div className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"><Icon name="chevronDown" className="w-4 h-4" /></div>
                                                        </div>
                                                    </div>
                                                    <div className="space-y-1.5">
                                                        <label className="text-xs font-bold text-slate-400 uppercase ml-1">è©•ä¼°æœˆä»½</label>
                                                        <div className="relative">
                                                            <select value={formData.month} onChange={(e) => handleInputChange('month', e.target.value)} className={`w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl font-medium appearance-none ${formData.month ? 'text-slate-700' : 'text-slate-400'}`}>
                                                                <option value="" disabled hidden>é»é¸é¸æ“‡</option>
                                                                {MONTHS.map(m => <option key={m} value={m}>{m}</option>)}
                                                            </select>
                                                            <div className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"><Icon name="calendar" className="w-4 h-4" /></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </section>

                                    <section className="bg-white p-6 md:p-8 rounded-3xl shadow-sm border border-slate-100">
                                        <div className="flex items-center gap-3 mb-6 pb-4 border-b border-slate-50">
                                            <div className="w-8 h-8 rounded-lg bg-indigo-50 flex items-center justify-center text-indigo-600"><Icon name="clipboard" className="w-5 h-5" /></div>
                                            <h2 className="text-lg font-bold text-slate-800">é‡èƒ½èˆ‡å“è³ª KPI</h2>
                                        </div>
                                        <div className="space-y-2">
                                            {KPI_CONFIG.map(config => {
                                                const status = getStatus(formData[config.id], config);
                                                const inputClass = getInputBorderClass(formData[config.id], config);
                                                return (
                                                    <div key={config.id} className="group p-4 rounded-xl hover:bg-slate-50 transition-colors border border-transparent hover:border-slate-100">
                                                        <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                                                            <div className="flex-1 min-w-0">
                                                                <div className="flex items-baseline gap-2 mb-1">
                                                                    <label className="text-sm font-bold text-slate-700 truncate">{config.label}</label>
                                                                    <span className="text-xs font-medium text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded">{config.unit}</span>
                                                                </div>
                                                                <p className="text-xs text-slate-400 truncate">{config.desc}</p>
                                                            </div>
                                                            <div className="flex items-center justify-between w-full sm:w-auto gap-4 mt-2 sm:mt-0">
                                                                <div className="text-right hidden sm:block">
                                                                    <p className="text-[10px] uppercase font-bold text-slate-400 tracking-wider mb-0.5">ç›®æ¨™</p>
                                                                    <p className="text-xs font-medium text-slate-600 font-mono">{config.type === 'lower_better' ? 'â‰¤' : 'â‰¥'} {config.target}</p>
                                                                </div>
                                                                <div className={`flex items-center gap-3 p-1 rounded-lg border transition-colors shadow-sm ${inputClass}`}>
                                                                    <input type="number" inputMode="decimal" value={formData[config.id]} onChange={(e) => handleInputChange(config.id, e.target.value)} className="w-28 px-2 py-1 text-right font-mono text-lg font-bold bg-transparent outline-none placeholder-slate-400 placeholder:text-sm text-inherit appearance-none" placeholder={config.isScore ? "é è¨­(0-5)" : "é è¨­æ•¸å€¼"} />
                                                                </div>
                                                                <div className="w-[68px] flex justify-end"><StatusBadge status={status} /></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </section>

                                    <section className="bg-white p-6 md:p-8 rounded-3xl shadow-sm border border-slate-100">
                                        <div className="flex items-center gap-3 mb-6 pb-4 border-b border-slate-50">
                                            <div className="w-8 h-8 rounded-lg bg-indigo-50 flex items-center justify-center text-indigo-600"><Icon name="trending" className="w-5 h-5" /></div>
                                            <h2 className="text-lg font-bold text-slate-800">æˆé•·èˆ‡è²¢ç»</h2>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div className="space-y-2">
                                                <label className="text-sm font-bold text-slate-700 flex items-center gap-2"><span className="w-1.5 h-1.5 rounded-full bg-indigo-400"></span>æœ¬æœˆæŠ€è¡“æˆé•·é‡é»</label>
                                                <textarea rows={6} value={formData.growthFocus} onChange={(e) => handleInputChange('growthFocus', e.target.value)} className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none resize-none text-base" placeholder="è«‹æ¢åˆ—å¼ç´€éŒ„..."></textarea>
                                            </div>
                                            <div className="space-y-2">
                                                <label className="text-sm font-bold text-slate-700 flex items-center gap-2"><span className="w-1.5 h-1.5 rounded-full bg-teal-400"></span>æœ¬æœˆåœ˜éšŠè²¢ç»èˆ‡å”ä½œ</label>
                                                <textarea rows={6} value={formData.teamContribution} onChange={(e) => handleInputChange('teamContribution', e.target.value)} className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none resize-none text-base" placeholder="è«‹æ¢åˆ—å¼ç´€éŒ„..."></textarea>
                                            </div>
                                        </div>
                                    </section>
                                </div>

                                {/* Right Column */}
                                <div className="lg:col-span-5 space-y-6">
                                    <div className="sticky top-24 space-y-6">
                                        <div id="action-buttons-container" className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col sm:flex-row items-center justify-between gap-4">
                                            <div className="flex gap-2 w-full sm:w-auto">
                                                <button onClick={resetForm} className="flex-1 sm:flex-none text-slate-400 hover:text-slate-600 text-xs font-semibold px-4 py-2 border border-transparent hover:border-slate-100 rounded-lg transition-colors">é‡ç½®</button>
                                                <button onClick={downloadImage} disabled={downloading} className="flex-1 sm:flex-none flex items-center justify-center gap-2 px-4 py-2 bg-indigo-50 text-indigo-600 hover:bg-indigo-100 rounded-xl font-bold transition-colors disabled:opacity-50">
                                                    {downloading ? <Icon name="loader" className="animate-spin w-4 h-4" /> : <Icon name="download" className="w-4 h-4" />}
                                                    <span className="text-sm">ä¸‹è¼‰åœ–ç‰‡</span>
                                                </button>
                                            </div>
                                            <button onClick={handleSave} disabled={saveStatus === 'saving' || saveStatus === 'success'} className={`w-full sm:w-auto flex items-center justify-center gap-2 px-6 py-2.5 rounded-xl font-bold text-white shadow-lg transition-all active:scale-95 ${saveStatus === 'success' ? 'bg-emerald-500' : 'bg-slate-900 hover:bg-slate-800'}`}>
                                                {saveStatus === 'saving' ? <span className="flex items-center gap-2 text-sm"><Icon name="loader" className="animate-spin w-4 h-4" />ä¿å­˜ä¸­</span> : saveStatus === 'success' ? <span className="flex items-center gap-2 text-sm"><Icon name="check" className="w-4 h-4" />å·²ä¿å­˜</span> : <span className="text-sm">ä¿å­˜ç´€éŒ„</span>}
                                            </button>
                                        </div>

                                        {/* Chart */}
                                        <section className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 overflow-hidden relative">
                                            <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 to-violet-500"></div>
                                            <h2 className="text-lg font-bold text-slate-800 mb-6">èƒ½åŠ›åˆ†ä½ˆé›·é”åœ–</h2>
                                            <div className="h-[280px] w-full -ml-2 relative z-10">
                                                <ResponsiveContainer width="100%" height="100%">
                                                    <RadarChart cx="50%" cy="50%" outerRadius="70%" data={radarData}>
                                                        <PolarGrid stroke="#e2e8f0" />
                                                        <PolarAngleAxis dataKey="subject" tick={{ fill: '#64748b', fontSize: 11, fontWeight: 500 }} />
                                                        <PolarRadiusAxis angle={30} domain={[0, 100]} tick={false} axisLine={false} />
                                                        <Radar name="KPI Achievement" dataKey="A" stroke="#6366f1" strokeWidth={2.5} fill="#6366f1" fillOpacity={0.2} />
                                                        <Tooltip />
                                                    </RadarChart>
                                                </ResponsiveContainer>
                                            </div>
                                        </section>

                                        {/* Summary */}
                                        <section className="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden group">
                                            <div className="bg-slate-50/80 backdrop-blur-sm border-b border-slate-100 p-4 flex items-center justify-between">
                                                <div className="flex items-center gap-2.5"><div className="bg-white p-1.5 rounded-lg border border-slate-200 shadow-sm text-slate-600"><Icon name="copy" className="w-4 h-4" /></div><h2 className="text-sm font-bold text-slate-700">æœ¬æœˆè©•ä¼°æ‘˜è¦</h2></div>
                                                <button onClick={copySummary} disabled={copyStatus === 'copied'} className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-bold transition-all border ${copyStatus === 'copied' ? 'bg-emerald-50 text-emerald-600 border-emerald-200' : 'bg-white text-slate-600 border-slate-200 hover:border-indigo-300'}`}>
                                                    {copyStatus === 'copied' ? <><Icon name="check" className="w-3 h-3" />å·²è¤‡è£½</> : <><Icon name="copy" className="w-3 h-3" />è¤‡è£½å…§å®¹</>}
                                                </button>
                                            </div>
                                            <div className="p-6 bg-white relative min-h-[300px]">
                                                <div className="font-mono text-sm text-slate-600 leading-relaxed whitespace-pre-wrap relative z-10">
                                                    {`${formData.month || 'æœªå¡«'}ï½œ${formData.branch || 'æœªå¡«'}ï½œ${formData.therapistName || 'æœªå¡«'} ${currentTherapist.title} çš„æ¯æœˆ KPI è‡ªè©•\n\nğŸ“Š é‡èƒ½èˆ‡å“è³ªæŒ‡æ¨™ï¼š\n${KPI_CONFIG.map(c => `- ${c.label}ï¼š${formData[c.id] || 'æœªå¡«'} ${c.unit}`).join('\n')}\n\nğŸ§  æœ¬æœˆæŠ€è¡“æˆé•·é‡é»ï¼š\n${formData.growthFocus || 'ï¼ˆæœªå¡«å¯«ï¼‰'}\n\nğŸ¤ æœ¬æœˆå°åœ˜éšŠçš„è²¢ç»èˆ‡å”ä½œï¼š\n${formData.teamContribution || 'ï¼ˆæœªå¡«å¯«ï¼‰'}`}
                                                </div>
                                            </div>
                                            <div className="bg-slate-50 p-3 border-t border-slate-100 text-[10px] text-center text-slate-400 font-medium tracking-wider">CONFIDENTIAL SELF-EVALUATION REPORT</div>
                                        </section>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
